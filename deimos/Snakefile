from os.path import *
import deimos
import numpy as np
from os.path import *
import pandas as pd
import glob


localrules: ms2mgf

# infer wildcards from inputs
fns = [basename(x) for x in glob.glob(join('input', '*.*'))]
IDS = [splitext(x)[0] for x in fns]
lookup = {k: v for k, v in zip(IDS, fns)}


rule all:
    input:
        expand(join('output', 'peakpick', '{id}_ms1_peaks.h5'), id=IDS)


rule mzml2hdf:
    input:
        lambda wildcards: join('input', lookup[wildcards.id])
    output:
        join('output', 'parsed', '{id}.h5')
    run:
        data = deimos.utils.read_mzml(input[0], accession={'drift_time': 'MS:1002476',
                                                           'retention_time': 'MS:1000016'})
        deimos.utils.save_hdf(output[0], data)


rule peakpick_ms1:
    input:
        rules.mzml2hdf.output
    output:
        join('output', 'peakpick', '{id}_ms1_peaks.h5')
    run:
        data = deimos.utils.load_hdf(input[0], level='ms1')
        peaks = deimos.peakpick.auto(data)
        deimos.utils.save_hdf(output[0], {'ms1': peaks})
