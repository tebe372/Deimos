from os.path import *
import spextractor as spx
import numpy as np
from os.path import *


# infer wildcards from inputs
IDS, = glob_wildcards(join('input', '{id}.d'))


rule all:
    input:
        expand(join('output', 'aligned', '{id}.npy'), id=IDS)


rule agilent2mzml:
    input:
        join('input', '{id}.d')
    output:
        join('output', 'mzml', '{id}.mzML.gz')
    log:
        join('output', 'logs', 'agilent2mzml', '{id}.log')
    run:
        outdir = dirname(output[0])
        shell('msconvert.exe {input} -o {outdir} --32 --mz32 --inten32 -z -g --filter “defaultArrayLength 20-” > {log} 2>&1')


rule mzml2h5:
    input:
        rules.agilent2mzml.output
    output:
        join('output', 'h5', '{id}.h5')
    run:
        spx.process.mzML(input[0], output[0])


rule align:
    input:
        rules.mzml2h5.output
    output:
        join('output', 'aligned', '{id}.npy')
    run:
        spx.process.align(input[0], output[0])
